function initGlobal(a){a=a,nickDialog=new NickDialog,accountDialog=new AccountDialog,changePwDialog=new ChangePwDialog,registerDialog=new RegisterDialog,snapID=void 0,a&&(snapID=a.snapshotID),roomDialog=new RoomDialog(snapID),errorDialog=new ErrorDialog,infoDialog=new InfoDialog,galleriesDialog=new GalleriesDialog,loginDialog=new LoginDialog,initGlobalResizeHandler(),$("#manage_account_btn").click(manageAccount)}function SnapshotUI(){var a=new ModDialog("snapshot",opts.snapshotID);$("#mod_button").click(function(){a.show()})}function manageAccount(){"guest"==conf.sessionData.type?nickDialog.show():accountDialog.show()}function initGlobalResizeHandler(){$(window).resize(function(){$(".ui-dialog-content:visible").each(function(){$(this).dialog("option","position",$(this).dialog("option","position"))})})}function receiveSessionData(a){conf.sessionData=a,insertSessionName("nick_indicator",a)}function insertSessionName(a,b){$("#"+a).text(b.name),"mod"==b.type?($("#"+a).addClass("nick_indicator_mod"),$("#"+a).removeClass("nick_indicator_user"),$("#"+a).removeClass("nick_indicator_guest")):"user"==b.type?($("#"+a).removeClass("nick_indicator_mod"),$("#"+a).addClass("nick_indicator_user"),$("#"+a).removeClass("nick_indicator_guest")):($("#"+a).removeClass("nick_indicator_mod"),$("#"+a).removeClass("nick_indicator_user"),$("#"+a).addClass("nick_indicator_guest"))}function GalleryUI(a){var c=function(a){"room"==a?$("#gallery_type_room").attr("checked","checked"):$("#gallery_type_snapshot").attr("checked","checked"),$("#gallery_public").attr("checked","checked"),$("#gallery_not_deleted").attr("checked","checked"),$(".gallery_opts").checkboxradio(),$(".gallery_opts").change(this.requestGallery),d()};this.requestGallery=function(){var a="gallery_type_snapshot"==getRadio("gallery_type")?"snapshot":"room",b="snapshot"==a?"Snapshots":"Rooms";b="DrawIO - "+b,window.history.pushState("new type",b,"/gallery/"+a+"s"),document.title=b;var c="gallery_private"==getRadio("gallery_visibility"),e="gallery_deleted"==getRadio("gallery_deleted");$.ajax({url:"/ajax/gallery/"+a+"s",data:{isPrivate:c,isDeleted:e}}).done(function(a){$("#gallery").html(a),d()})};var d=function(){0!=$("#gallery_more").length&&$("#gallery_more").click(function(){var a=$("input[type='radio']:checked.gallery_type").attr("id"),b="galleries_snapshots"==a?"snapshot":"room",c=e(),f={oldestTime:""+c};$.ajax({url:"/ajax/gallery/"+b+"s",data:f}).done(function(a){$("#gallery_more_container").replaceWith(a),d()})})},e=function(){var a=null;return $(".thumb_ago").each(function(){var b=parseInt($(this).data("unixtime"));(null==a||b<a)&&(a=b)}),a};c(a)}function ModDialog(a,b,c){this.entityType=a,this.entityID=b,this.processCallback=c||null;var d=this;this.init=function(){this.setup()},this.setup=function(){$("#mod_dialog").dialog({resizable:!1,width:400,modal:!0,draggable:!1,autoOpen:!1,closeOnEscape:!1,open:function(a,b){modalOpenSetup(),d.configureRadios()}}),$("#mod_ok").click(function(){d.process(),$("#mod_dialog").dialog("close")}),$("#mod_cancel").click(function(){$("#mod_dialog").dialog("close")})},this.configureRadios=function(){configureRadio("mod_visibility",opts.isPrivate?"mod_visibility_private":null),configureRadio("mod_deleted",opts.isDeleted?"mod_deleted_yes":null),void 0===opts.isStaffPick?$("#mod_staff_pick_container").hide():($("#mod_staff_pick_container").show(),configureRadio("mod_staffpick",opts.isStaffPick?"mod_staffpick_yes":null))},this.process=function(){var a="mod_visibility_private"==getRadio("mod_visibility"),b="mod_deleted_yes"==getRadio("mod_deleted"),c="mod_staffpick_yes"==getRadio("mod_staffpick");$.ajax({url:"/ajax/moderate",data:{id:d.entityID,type:d.entityType,isPrivate:a?1:0,isDeleted:b?1:0,isStaffPick:c?1:0}}).done(function(a){processError(a)||(this.processCallback&&this.processCallback(a),infoDialog.show("Settings applied."))})},this.show=function(a){$("#mod_dialog").dialog("open")},this.init()}function configureRadio(a,b){$("."+a).checkboxradio(),b?$("#"+b).attr("checked","checked"):$("."+a+":first").attr("checked","checked"),$("."+a).checkboxradio("refresh")}function getRadio(a){return $("input[type='radio']:checked."+a).attr("id")}function NickDialog(){function b(){c(),receiveSessionData(conf.sessionData)}function c(){$("#nick_dialog").dialog({resizable:!1,width:400,modal:!0,draggable:!1,autoOpen:!1,closeOnEscape:!1,open:function(a,b){modalOpenSetup(),$("#nick_input").select(),$("#nick_dialog").show()}}),$("#nick_input").click(function(){$(this).select()}),$("#nick_ok").click(function(){var a=$("#nick_input").val();$.ajax({url:"/ajax/set_session_name",data:{name:a}}).done(function(a){var b=function(){nickDialog.show()};$("#nick_dialog").dialog("close"),processError(a,b)||(receiveSessionData(a),registerDialog.show())})}),$("#nick_cancel").click(function(){$("#nick_dialog").dialog("close")}),$("#nick_login").click(function(){$("#nick_dialog").dialog("close"),$("#login_dialog").dialog("open")})}return this.show=function(){$("#nick_input").val(conf.sessionData.name),$("#nick_dialog").dialog("open")},b(),this}function AccountDialog(){function b(){c()}function c(){$("#account_dialog").dialog({resizable:!1,width:400,modal:!0,draggable:!1,autoOpen:!1,closeOnEscape:!1,open:function(a,b){insertSessionName("account_dialog_name",conf.sessionData),modalOpenSetup()}}),$("#account_change_pw").click(function(){$("#account_dialog").dialog("close"),changePwDialog.show()}),$("#account_logout").click(function(){$.ajax({url:"/ajax/logout"}).done(function(a){$("#account_dialog").dialog("close"),processError(a,function(){accountDialog.show()})||(receiveSessionData(a),$("#account_dialog").dialog("close"),infoDialog.show("You are now logged out."))})}),$("#account_continue").click(function(){$("#account_dialog").dialog("close")})}return this.show=function(){$("#account_dialog").dialog("open")},b(),this}function ChangePwDialog(){function a(){b()}function b(){$("#change_pw_dialog").dialog({resizable:!1,width:400,modal:!0,draggable:!1,autoOpen:!1,closeOnEscape:!1,open:function(a,b){modalOpenSetup()}}),$("#change_pw_cancel").click(function(){$("#change_pw_dialog").dialog("close")}),$("#change_pw_submit").click(function(){$.ajax({url:"/ajax/changepw",data:{pwCurr:$("#change_pw_curr").val(),pw1:$("#change_pw1").val(),pw2:$("#change_pw2").val()}}).done(function(a){$("#change_pw_dialog").dialog("close"),processError(a,function(){changePwDialog.show()})||infoDialog.show("Password changed successfully.")})})}return this.show=function(){$("#change_pw_curr").val(""),$("#change_pw1").val(""),$("#change_pw2").val(""),$("#change_pw_dialog").dialog("open")},a(),this}function LoginDialog(){function b(){c()}function c(){$("#login_dialog").dialog({resizable:!1,width:400,modal:!0,draggable:!1,autoOpen:!1,closeOnEscape:!1,open:function(a,b){modalOpenSetup(),$("#login_dialog").show(),$("#login_username").val(""),$("#login_password").val("")}}),$("#login_back").click(function(){$("#login_dialog").dialog("close"),nickDialog.show()}),$("#login_cancel").click(function(){$("#login_dialog").dialog("close")}),$("#login_submit").click(function(){$.ajax({url:"/ajax/login",data:{username:$("#login_username").val(),password:$("#login_password").val()}}).done(function(a){$("#login_dialog").dialog("close"),processError(a,function(){loginDialog.show()})||(receiveSessionData(a),$("#login_dialog").dialog("close"),infoDialog.show("You are now logged in."))})})}return this.show=function(a){$("#login_dialog").dialog("open")},b(),this}function RegisterDialog(){function b(){c()}function c(){$("#register_dialog").dialog({resizable:!1,width:400,modal:!0,draggable:!1,autoOpen:!1,closeOnEscape:!1,open:function(a,b){modalOpenSetup()}}),$("#register_back").click(function(){$("#register_dialog").dialog("close"),nickDialog.show()}),$("#register_skip").click(function(){$("#register_dialog").dialog("close")}),$("#register_ok").click(function(){$.ajax({url:"/ajax/register",data:{pw1:$("#register_pw1").val(),pw2:$("#register_pw2").val(),"g-recaptcha-response":grecaptcha.getResponse(a.grWidgetID)}}).done(function(a){$("#register_dialog").dialog("close"),processError(a,function(){registerDialog.show()})||(receiveSessionData(JSON.parse(a)),infoDialog.show("Registration successful, you are now logged in."))})})}var a=this;return this.show=function(){$("#register_dialog").dialog("open"),renderCaptcha(a,"register_captcha")},b(),a}function renderCaptcha(a,b){void 0!==a.grWidgetID?grecaptcha.reset(a.grWidgetID):a.grWidgetID=grecaptcha.render(b,{sitekey:conf.recaptchaSiteKey})}function GalleriesDialog(){function b(){c()}function c(){$("#galleries_dialog").dialog({resizable:!1,width:400,modal:!0,draggable:!1,autoOpen:!1,closeOnEscape:!1,open:function(a,b){modalOpenSetup()}}),$("#galleries_cancel").click(function(){$("#galleries_dialog").dialog("close")}),$("#galleries_ok").click(function(){window.location.href="/gallery/rooms"}),$("#galleries_btn").click(a.show)}var a=this;return this.show=function(){$("#galleries_dialog").dialog("open")},b(),this}function ErrorDialog(){function a(){b()}function b(){$("#error_dialog").dialog({resizable:!1,width:400,modal:!0,draggable:!1,autoOpen:!1,closeOnEscape:!1,open:function(a,b){modalOpenSetup()}})}return this.show=function(a,b){$("#error_dialog").prev().find(".ui-dialog-title").html('<i class="fa fa-times button_icon" aria-hidden="true"></i>Error');var d=$("#error_button");d.off(),d.click(function(){$("#error_dialog").dialog("close"),b&&b()}),errorMessage="Unknown error.",a&&(errorMessage=a),$("#error_message").html(errorMessage),$("#error_dialog").dialog("open")},a(),this}function InfoDialog(){function a(){b()}function b(){$("#info_dialog").dialog({resizable:!1,width:400,modal:!0,draggable:!1,autoOpen:!1,closeOnEscape:!1,open:function(a,b){modalOpenSetup()}})}return this.show=function(a){$("#info_dialog").prev().find(".ui-dialog-title").html('<i class="fa fa-info button_icon" aria-hidden="true"></i>Info');var c=$("#info_button");c.off(),c.click(function(){$("#info_dialog").dialog("close")}),$("#info_message").html(a),$("#info_dialog").dialog("open")},a(),this}function processError(a,b){if(a.error)return errorDialog.show(a.error,b),!0;if(a.errors){for(var c=a.errors,d="",e=0;e<c.length;e++)d+='<p class="modal_message">'+c[e]+"</p>";return errorDialog.show(d,b),!0}return!1}function RoomDialog(a){function e(){g(),$("#create_drawing_btn").click(function(){f("Create new room"),d.show()});var b=$("#create_snapshot_room");1==b.length&&b.click(function(){f("Create new room from image"),d.show(a)})}function f(a){$("#room_dialog").prev().find(".ui-dialog-title").text(a)}function g(){$("#room_dialog").dialog({resizable:!1,width:400,modal:!0,draggable:!1,autoOpen:!1,closeOnEscape:!1,open:function(a,b){modalOpenSetup(),$(".room_visibility").checkboxradio(),$(".room_visibility:first").attr("checked","checked"),$(".room_visibility").checkboxradio("refresh"),$(".room_visibility").change(function(){"room_visibility_public"==$(this).attr("id")?($("#room_public_info").show(),$("#room_private_info").hide()):($("#room_public_info").hide(),$("#room_private_info").show())}),$("#nick_dialog").show()}}),$("#room_name_input").click(function(){$(this).select()}),$("#room_name_input").select(),$("#room_ok").click(function(){h(),$("#room_dialog").dialog("close")}),$("#room_cancel").click(function(){$("#room_dialog").dialog("close")})}function h(){var a=$("#room_name_input").val(),c=$("input[type='radio']:checked.room_visibility").attr("id"),e="room_visibility_private"==c,f={name:a,isPrivate:e,"g-recaptcha-response":grecaptcha.getResponse(d.grWidgetID)};null!=b&&(f.snapshotID=b),$.ajax({url:"/ajax/create_room",data:f}).done(function(a){var b=function(){d.show()};$("#room_dialog").dialog("close"),processError(a,b)||(window.location.href="/r/"+a)})}var b=null,d=this;this.show=function(a){if(renderCaptcha(d,"room_captcha"),b=void 0!==a?a:null){var c=$("#snapshot_title"),e=c.text();"An unnamed snapshot"==e&&(e="An unnamed room"),$("#room_name_input").val(e),$("#room_name_input").select()}else $("#room_name_input").val("An unnamed room"),$("#room_name_input").select();$("#room_dialog").dialog("open")},e()}function SnapshotDialog(a){function d(){$("#snapshot").click(b.show),e()}function e(){$("#snapshot_dialog").dialog({resizable:!1,width:400,modal:!0,draggable:!1,autoOpen:!1,closeOnEscape:!1,open:function(a,b){modalOpenSetup(),$(".snapshot_visibility").checkboxradio(),$(".snapshot_visibility:first").attr("checked","checked"),$(".snapshot_visibility").checkboxradio("refresh"),$(".snapshot_visibility").change(function(){"snapshot_visibility_public"==$(this).attr("id")?($("#snapshot_public_info").show(),$("#snapshot_private_info").hide()):($("#snapshot_public_info").hide(),$("#snapshot_private_info").show())}),$("#nick_dialog").show()}}),$("#snapshot_name_input").click(function(){$(this).select()}),$("#snapshot_name_input").select(),$("#snapshot_ok").click(function(){f(),$("#snapshot_dialog").dialog("close")}),$("#snapshot_cancel").click(function(){$("#snapshot_dialog").dialog("close")})}function f(){var a=$("#snapshot_name_input").val(),d=$("input[type='radio']:checked.snapshot_visibility").attr("id"),e="snapshot_visibility_private"==d;$.ajax({url:"/ajax/create_snapshot",data:{roomID:c,name:a,isPrivate:e,"g-recaptcha-response":grecaptcha.getResponse(b.grWidgetID)}}).done(function(a){processError(a)||(window.location.href="/s/"+a)})}var b=this,c=a;this.show=function(a){$("#snapshot_dialog").dialog("open"),renderCaptcha(b,"snapshot_captcha")},d()}function modalOpenSetup(){$(".ui-widget-overlay").css({"background-color":"#000",opacity:.5,"z-index":1000000020}),$(".ui-dialog").css({"z-index":1000000021}),$(".ui-dialog-titlebar-close").hide()}function drawUI(){function N(){fa();var a=$("body");j.mousedown($.proxy(function(a){if(P(),qa(),3==a.which){if(Ja())return;ua()}return ra(Wa(a)),!1},this)),j.mouseenter(function(a){L=!0,pa()||1==event.which&&(P(),ra(Wa(a)))}),j.contextmenu(function(a){return!1}),a.keydown($.proxy(function(a){if(16==a.which){if(Ja())return;P(),Ha(),ua(),ra(M.newCoord)}else 13!=a.which||"text"!=M.tool||$("#text_input").is(":visible")?27==a.which&&"text"==M.tool&&Oa():Na()},this)),a.keyup($.proxy(function(a){if(16==a.which){if(Ja())return;P(),va(a),ta()}},this)),a.mousemove(function(a){P(),M.newCoord=Wa(a),"paint"==M.tool&&"drawing"==M.state&&M.meta.lineEntries.push({state:M.state,coord:M.newCoord}),"start"==M.state&&(M.state="drawing"),null==M.newCoord&&"eyedropper"!=M.tool?ta(a):R(M,!0)}),o.mouseup(ta),j.mouseleave(Q),o.mouseleave(Q),p.on("update_drawing",Ua),p.on("add_layer",Va),p.on("receive_mouse_coords",Sa),p.on("disconnect",O),$("body").attr("style","<style> \t-webkit-touch-callout: none;\t-webkit-user-select: none;\t-khtml-user-select: none;\t-moz-user-select: none;\t-ms-user-select: none;\tuser-select: none;</style>"),na(),Ta()}function O(){$("#disconnected_indicator").show()}function P(){null==M.layerCode&&(M.layerCode=randomString(q))}function Q(a){M.newCoord=null,L=!1,ta(a)}function R(a,b){b&&qa(),"flood"==a.tool&&b&&"start"==a.state&&null==C||("eyedropper"!=a.tool||!b||"start"!=a.state&&"drawing"!=a.state?"paint"==a.tool?T(a,b):"line"==a.tool?S(a,b):"text"==a.tool?U(a,b):b&&Ra(a):(ya(a),b&&Ra(a)))}function S(a,d){if("idle"==a.state)return void(d&&Ra(a));var e=ca(a,d);"start"==a.state||"drawing"==a.state?("start"==a.state&&ea(e),d?(ja(a),ba(),_(a,d),$.now()-s>f&&(s=$.now(),Qa(a))):_(a,d)):"end"==a.state&&(_(a,d),e.baseData=e.getImageData(0,0,b,c),Y(a,d),a.state="idle")}function T(a,b){if("start"==a.state||"drawing"==a.state)if(b){ja(a),ba();var c=JSON.parse(JSON.stringify(a));"start"==a.state&&(aa(a,b),Qa(c)),$.now()-s>e&&(aa(a,b),s=$.now(),Qa(c))}else null!=a.meta.lineEntries&&aa(a,b);else"end"==a.state?(b&&Qa(a),aa(a,b),Y(a,b),a.state="idle"):b&&Ra(a)}function U(a,b){var c=ca(a,b);if(!b||null!=a.meta&&void 0!==a.meta.text||W(a),b&&(ka(a),la(a)),"start"==a.state){if(b){if(!V(M))return;ba(),Z(a,b,c),$("#text_input_box").val(G),$("#text_input").hide(),Qa(a),W(a)}else Z(a,b,c);a.state="end",Y(a,b)}else"idle"==a.state&&X(a,b);"end"==a.state&&(a.state="idle")}function V(a){return"text"!=a.tool||""!=a.meta.text||(Na(),a.state="end",!1)}function W(a){a.meta={text:"",fontFace:"ubuntuRegular",fontSize:null}}function X(a,d){d&&Ra(a);var e=ca(a,d,"_preview");e.clearRect(0,0,b,c),d&&!L||Z(a,d,e)}function Y(a,b){if(b){var c=JSON.parse(JSON.stringify(a));c.state="end",Qa(c),"paint"==c.tool&&null!=c.meta&&null!=c.meta.lineEntries&&aa(c,!0),null!=C&&clearTimeout(C),C=setTimeout(function(){_a(c),a.layerCode=null},D)}}function Z(a,d,e){if(null==a.newCoord)return void e.clearRect(0,0,b,c);e.font=a.meta.fontSize+"px "+a.meta.fontFace,e.fillStyle=a.colourFg,e.textAlign="right";var f={x:a.newCoord.x-F,y:a.newCoord.y+Math.ceil(a.meta.fontSize/2)};return e.fillText(a.meta.text,f.x,f.y),e}function _(a,d){var e=ca(a,d),f=e.createImageData(b,c);if(void 0!==e.baseData&&f.data.set(e.baseData.data.slice()),null!=a.meta){var g=a.meta.startCoord;if(null!=g){var h=a.newCoord;null!=h&&(xa(f.data,a,g.x,g.y,h.x,h.y),e.putImageData(f,0,0))}}}function aa(a,d){if(null==a.meta)return void console.log("Warning -> drawPaint called without data!");var e=ca(a,d),f=e.getImageData(0,0,b,c),g=a.meta.lineEntries,h=g[0].coord;xa(f.data,a,h.x,h.y,h.x,h.y);for(var i=1;i<g.length;i++){var j=g[i-1].coord,k=g[i].coord;null!=j&&null!=k&&xa(f.data,a,j.x,j.y,k.x,k.y)}e.putImageData(f,0,0);var l=a.meta.lineEntries[a.meta.lineEntries.length-1];a.meta.lineEntries=[l]}function ba(){null!=C&&(clearTimeout(C),C=null)}function ca(a,b,c){void 0===c&&(c="");var d;if(b)d=m,"_preview"==c&&(d=n);else{d=da(a,c)[0].getContext("2d")}return d}function da(a,b){var c="canvas_layer_"+a.layerCode+b,d=$("#"+c);0==d.length&&(Xa(c),d=$("#"+c),Ya(d));var e=d[0];return void 0!==e.deleteTimeout&&clearTimeout(e.deleteTimeout),e.deleteTimeout=setTimeout(function(){d.remove()},w),d}function ea(a){a.baseData=a.getImageData(0,0,b,c)}function fa(){SnapshotDialog(a),ha("eyedropper"),ha("paint"),ha("line"),ha("flood"),ha("text"),$("#text").on("mouseup",function(){$("#text_input_box").focus()}),I=new ToolOptionMenu(this,"brush_size",null,null),J=new ToolOptionMenu(this,"font_size",null,null),K=new ToolOptionMenu(this,"font_face",function(a){$("#"+a+"-menu").parent().find(".ui-menu-item-wrapper").each(function(){var a=$(this);a.css("font-family",ga(a.html()))})},function(a){return'<span style="font-family: '+ga(a)+';">Font</span>'}),$("#mod_button").click(function(){v.show()}),Ga("paint"),$(window).on("resize",function(){I.position(),J.position(),K.position(),Ia(),Pa()})}function ga(a){for(var b=a.split(" "),c="ubuntu",d=1;d<b.length;d++){var e=b[d];c+=e.substring(0,1).toUpperCase()+e.substring(1)}return c}function ha(a){$("#"+a).on("mousedown",function(){Ga(a),ia(a)})}function ia(a){M.tool=a}function ja(a){a.meta.brushSize=(parseInt($("#brush_size").val())-1)/2}function ka(a){a.meta.fontSize=parseInt($("#font_size").val())}function la(a){a.meta.fontFace=ma()}function ma(){return ga($("#font_face").val())}function na(){B.spectrum({showAlpha:!1,cancelText:"Cancel",chooseText:"OK",show:oa})}function oa(){Ha(),Ia()}function pa(){return!$(".sp-container").first().hasClass("sp-hidden")}function qa(){M.colourFg=B.spectrum("get").toRgbString()}function ra(a){M.newCoord=a,null!=M.newCoord&&(M.state="start","paint"==M.tool?(M.meta={lineEntries:[{state:M.state,coord:M.newCoord}]},s=$.now()):"line"==M.tool?sa(M):"text"!=M.tool&&(M.meta=null),R(M,!0))}function sa(a){a.meta={startCoord:a.newCoord}}function ta(a){"drawing"!=M.state&&"start"!=M.state||(M.state="end"),R(M,!0),M.dropperToggle&&va(a)}function ua(){M.dropperToggle=!0,M.prevTool=M.tool,M.tool="eyedropper",Ga(M.tool)}function va(){M.dropperToggle=!1,M.tool=M.prevTool,"line"==M.tool&&sa(M),Ga(M.tool)}function wa(a){var b=a.meta.brushSize,c=[];for(x=0;x<2*b+1;x++){var d=[];for(y=0;y<2*b+1;y++){(x-b)*(x-b)+(y-b)*(y-b)<=b*b?d.push(!0):d.push(!1)}c.push(d)}return c}function xa(a,d,e,f,g,h){for(var p,i=wa(d),j=Ba(d.colourFg),k=Math.abs(g-e),l=e<g?1:-1,m=-Math.abs(h-f),n=f<h?1:-1,o=k+m;;){for(var q=-d.meta.brushSize,r=0;r<i.length;r++)for(var s=0;s<i[r].length;s++)if(1==i[r][s]){var t=e+q+r,u=f+q+s;t>=0&&t<b&&u>=0&&u<c&&Ea(a,t,u,j)}if(e==g&&f==h)break;p=2*o,p>=m&&(o+=m,e+=l),p<=k&&(o+=k,f+=n)}}function ya(a){if(null!=a.newCoord){var b=za(),c=b.getImageData(a.newCoord.x,a.newCoord.y,1,1).data;a.colourFg="rgba("+c[0]+", "+c[1]+", "+c[2]+", "+c[3]+")",B.spectrum("set",a.colourFg)}}function za(){var a=[];$(".drawing_layer").each(function(){a.push($(this))}),a.sort(function(a,b){var c=parseInt(a.css("z-index")),d=parseInt(b.css("z-index"));return c<d?-1:c>d?1:0});var d=l[0];d.setAttribute("width",b),d.setAttribute("height",c);var e=d.getContext("2d");e.clearRect(0,0,b,c);for(var f=0;f<a.length;f++){var g=a[f],h=parseInt(g.css("left")),i=parseInt(g.css("top"));e.drawImage(g[0],h,i)}return e}function Ba(a){var b=a.replace("rgb(","").replace("rgba(","").replace(")",""),c=b.split(","),d=parseFloat(c[3]);return out=[parseInt(c[0]),parseInt(c[1]),parseInt(c[2]),Math.round(255*(isNaN(d)?1:d))],out}function Da(a,c){return Math.floor(c)*(4*b)+4*Math.floor(a)}function Ea(a,b,c,d){var e=Da(b,c);a[e]=d[0],a[e+1]=d[1],a[e+2]=d[2],a[e+3]=d[3]}function Ga(a){var b=$("#"+a);$(".button_tool").each(function(){var a=$(this);a.attr("id")==b.attr("id")?a.addClass("button_pressed"):a.removeClass("button_pressed")}),"text"==a?Ma():Oa(),$(".controls_selectmenu").each(function(){var b=$(this).attr("id"),c=$("#"+b+"_container");"room_menu"==b||"text"==a&&("font_face"==b||"font_size"==b)||("paint"==a||"line"==a)&&"brush_size"==b?c.show():c.hide()})}function Ha(a){Oa(),void 0!==a&&"brush_size"!=a&&I.close(),void 0!==a&&"font_size"!=a&&J.close(),void 0!==a&&"font_face"!=a&&K.close()}function Ia(){var a=$(".sp-light").first().offset(),b=$(".sp-container").first();b.css({top:a.top+"px",left:a.left-b.width()+"px","z-index":1000000012})}function Ja(){return!!$("#text").hasClass("button_pressed")||(!!I.isOpen()||(!!pa()||(!!La()||!!Ka())))}function Ka(){var a=!1;return $(".ui-dialog").each(function(b){$(this).is(":visible")&&(a=!0)}),a}function La(){return"none"!=$(".ui-dialog").css("display")}function Ma(){"none"==$("#text_input").css("display")?Na():Oa()}function Na(){Ha(),$("#text_input").show(),Pa();var a=$("#text_input_box");a.focus(),a.css("font-family",ma()),a.focus(function(){$(this).select()}),a.keyup(function(){$(this).val()!=G&&(M.meta.text=$(this).val(),X(M,!0))}),a.keydown(function(a){13==a.keyCode&&Oa()})}function Oa(){$("#text_input").hide()}function Pa(){var a=$("#text_input");if("none"!=a.css("display")){var b=$("#drawing_form"),c=b.offset(),d=c.left;a.css({top:c.top+"px",left:d+"px","z-index":1000000012})}}function Qa(a){var b=conf.sessionData.name;b||(b="Anonymous"),a.nickname=b,p.emit("receive_tool",a)}function Ra(a,b){return $.now()-s>h&&("paint"==a.tool&&null!=a.meta&&null!=a.meta.lineEntries&&(a.meta.lineEntries=null),Qa(a),s=$.now(),!0)}function Sa(a){var b=a.socketID,c=$("#drawing_pointer_"+b);if(null==a.newCoord)return c.fadeOut(z,function(){c.remove()}),void R(a,!1);if(0==c.length){var d='<div id="drawing_pointer_'+b+'" class="drawing_pointer"><div class="pointer_dot"></div><div id="drawing_pointer_label_'+b+'" class="pointer_label"></div></div>';$("#drawing_layers").append(d),c=$("#drawing_pointer_"+b)}c.css({left:a.newCoord.x+"px",top:a.newCoord.y+"px"});var e=a.nickname?a.nickname:"Anonymous";$("#drawing_pointer_label_"+b).text(e),c[0].timeout&&clearTimeout(c[0].timeout),c[0].timeout=setTimeout(function(){c.fadeOut(z,function(){c.remove()})},E),R(a,!1)}function Ta(){p.emit("get_drawing",{drawID:a,sessionID:getCookie("sessionID")})}function Ua(a){a=$.parseJSON(a);var b=null;$.each(a,function(a,c){var d=parseInt(a);(null==b||d<b)&&(b=d),$a(d,c,!1)})}function Va(a){a=$.parseJSON(a),$a(a.id,a.layer,!1)}function Wa(a){var b=i[0].getBoundingClientRect();if(void 0==a.clientX||void 0==a.clientY)return null;var c={x:Math.round(a.clientX-b.left),y:Math.round(a.clientY-b.top)};return c.x<0||c.x>=b.width||c.y<0||c.y>=b.height?null:c}function Xa(a){var d='<canvas id="'+a+'" width="'+b+'" height="'+c+'" style="z-index: 0;" class="drawing_canvas"> </canvas><canvas id="'+a+'_preview" width="'+b+'" height="'+c+'" style="z-index: 0;" class="drawing_canvas"> </canvas>';$("#drawing_layers").append(d)}function Ya(a){$(".drawing_canvas").each(function(){var a=$(this),b=parseInt(a.css("z-index"))-1;a.css("z-index",b)});var b=$("#"+a.attr("id")+"_preview");a.css("z-index",A),b.css("z-index",A)}function Za(a){var b=$("#canvas_layer_"+a);if(b.length>0)return b;var b=$("#drawing_layer_"+a);return b.length>0?b:null}function $a(a,b,c){var d={};d.layer=b,d.duplicate=Za(d.layer.code),d.previewDuplicate=Za(d.layer.code+"_preview"),null!=d.duplicate&&d.duplicate.attr("id","duplicate_temp");var e=c?1e3:0,f="drawing_layer_"+d.layer.code,g='<img id="'+f+'" class="drawing_layer" src="'+d.layer.base64+'" style="z-index: '+(a+e)+"; left: "+d.layer.offsets.left+"px; top: "+d.layer.offsets.top+'px;"/>';$("#drawing_layers").append(g),$("#"+f).imagesLoaded().done(function(){if(void 0!==d.layer.components)for(var a=d.layer.components,b=0;b<a.length;b++){var c=a[b],e=Za(c);null!=e&&e.remove();var f=Za(a[b]);null!=f&&f.remove()}null!=d.duplicate&&d.duplicate.remove(),null!=d.previewDuplicate&&d.previewDuplicate.remove()}),a>r&&(r=a)}function _a(d){var e=d.layerCode,f=ab(e);m.clearRect(0,0,b,c);var g=bb(f[0],k[0],d);k[0].toBlob(function(b){var c=new FileReader;c.onload=function(c){var d={drawID:a,base64:c.target.result,offsets:g,code:e};$a(r+1,d,!0),f.remove();var h=new window.FileReader;h.readAsDataURL(b),h.onloadend=function(){h.result;p.emit("add_layer",d)}},c.readAsDataURL(b)},"image/png")}function ab(a){var d="drawing_canvas_cpy_"+a,e='<canvas id="'+d+'" class="drawing_canvas_cpy" width="'+b+'" height="'+c+'"></canvas>',f=$(e),g=m.getImageData(0,0,b,c);return f[0].getContext("2d").putImageData(g,0,0),f.insertBefore(i),f}function bb(a,b,c){var d=a.getContext("2d"),e=a.width,f=a.height,g=d.getImageData(0,0,e,f),h=g.data,i=function(a,b){return 0!=h[4*(e*b+a)+3]},j=function(a){for(var b=a?1:-1,c=a?0:f-1;a?c<f:c>-1;c+=b)for(var d=0;d<e;d++)if(i(d,c))return c;return null},k=function(a){for(var b=a?1:-1,c=a?0:e-1;a?c<e:c>-1;c+=b)for(var d=0;d<f;d++)if(i(c,d))return c;return null},l=j(!0),m=j(!1)+1,n=k(!0),o=k(!1)+1,p=o-n,q=m-l;return b.setAttribute("width",p),b.setAttribute("height",q),b.getContext("2d").drawImage(a,n,l,p,q,0,0,p,q),{top:l,right:o,bottom:m,left:n}}var a=opts.roomID,b=opts.width,c=opts.height,d=33,e=d,f=d,h=20,i=$("#drawing_canvas"),j=$("#drawing_canvas_preview"),k=$("#crop_canvas"),l=$("#scratch_canvas"),m=i[0].getContext("2d"),n=j[0].getContext("2d"),o=$(document),p=io.connect("/drawing_socket_"+a),q=32,r=1,s=$.now(),v=($.now(),new ModDialog("room",a)),w=4e3,z=120,A=999999999,B=$("#colour_picker"),C=null,D=1e3,E=4e3,F=10,G="Enter text",I=null,J=null,K=null,L=!1,M={state:"idle",tool:"paint",meta:null};this.methods={closeMenus:Ha},N()}function ToolOptionMenu(a,b,c,d,e,f){function o(){i.selectmenu({open:function(){n.position()},close:function(a){var b=$("#"+h+"-button");b.removeClass("button_pressed"),b.blur()},create:function(){p(this)},select:function(){p(this),e&&k($(this).val())}}),$("#"+h+"-button").addClass("button_tool")}function p(a){var b=$("#"+h),c=b.selectmenu("widget"),d=null!=l?l($(a).val()):$(a).val();c.html('<span class="ui-selectmenu-text"><i class="fa fa-caret-left" aria-hidden="true"></i>&nbsp;'+d+"</span>")}var g=a,h=b,i=$("#"+h),j=c,k=e,l=d,m=!!f,n=this;this.position=function(){var a=$("#"+h+"-menu").parent();if("none"!=a.css("display")){g.methods.closeMenus(h);var b=$("#"+h+"-button");a.hide(),null!=j&&j(h);var c=b.offset();a.show(),a.css({top:c.top-a.height()+45+"px",left:c.left-a.width()+"px","z-index":1000000012}),m&&$("#"+h+"-menu").find(".ui-state-active").removeClass("ui-state-active"),$("#"+h+"-button").addClass("button_pressed")}},this.close=function(){$("#"+h+"-button").removeClass("button_pressed"),$("#"+h).selectmenu("close")},this.isOpen=function(){return"none"!=$("#"+h+"-menu").parent().css("display")},o()}function randomString(a){for(var b="",c="abcdefghijklmnopqrstuvwxyz0123456789",d=0;d<a;d++)b+=c.charAt(Math.floor(Math.random()*c.length));return b}function setCookie(a,b,c){var d=new Date;d.setTime(d.getTime()+24*c*60*60*1e3);var e="expires="+d.toUTCString();document.cookie=a+"="+b+";"+e+";path=/"}function getCookie(a){for(var b=a+"=",c=decodeURIComponent(document.cookie),d=c.split(";"),e=0;e<d.length;e++){for(var f=d[e];" "==f.charAt(0);)f=f.substring(1);if(0==f.indexOf(b))return f.substring(b.length,f.length)}return null}function Timeline(){this.entries=[],this.log=function(a){var b=Date.now();this.entries.push({name:a,ts:b})},this.dump=function(){console.log("Timeline.dump() invoked");for(var a,b=null,c=0;c<this.entries.length;c++){var a=this.entries[c];if(null!=b){var d=a.ts-b.ts;console.log("["+b.name+"] => ["+a.name+"] "+d+" ms")}b=a}}}var errorDialog,roomDialog,registerDialog,nickDialog,errorDialog,loginDialog,modDialog=null,conf;