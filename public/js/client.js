function initSplash(){$("#create_drawing_btn").click(function(){$.ajax({url:"/create_drawing"}).done(function(a){window.location.href="/d/"+a})}),configureNick(),setupResizeHandler()}function setupResizeHandler(){$("body").resize(function(){winHeight=parseInt($(window).height()),winWidth=parseInt($(window).width())})}function configureNick(){setupNickModal();var a=getCookie("nick");null==a?showNickModal():($("#nick_dialog").hide(),$("#nick_indicator").text(a)),$("#change_nick_btn").click(function(){showNickModal(!0)})}function showNickModal(a){var b=getCookie("nick");null!=b&&$("#nick_input").val(b),$("#nick_dialog").dialog("open"),a&&($("#nick_message").html("Please enter a new nickname."),$(".ui-dialog-title").html("Alert"))}function setupNickModal(){$("#nick_dialog").dialog({resizable:!1,height:202,width:400,modal:!0,draggable:!1,autoOpen:!1,closeOnEscape:!1,open:function(a,b){$(".ui-widget-overlay").css({"background-color":"#000",opacity:.5,"z-index":2000000020}),$(".ui-dialog").css({"z-index":2000000021}),$("#nick_input").click(function(){$(this).select()}),$("#nick_input").select(),$("#nick_button").click(function(){var a=$("#nick_input").val();setCookie("nick",a,30),$("#nick_indicator").text(a),$("#nick_dialog").dialog("close")}),$(".ui-dialog-titlebar-close").hide(),$("#nick_dialog").show()}})}function drawUI(a,b,c){function O(){ga();var a=$("body");l.mousedown($.proxy(function(a){if(Q(),ra(),3==a.which){if(Ka())return;va()}return sa(Wa(a)),!1},this)),l.mouseenter(function(a){M=!0,qa()||1==event.which&&(Q(),sa(Wa(a)))}),l.contextmenu(function(a){return!1}),a.keydown($.proxy(function(a){if(16==a.which){if(Ka())return;Q(),Ia(),va(),sa(N.newCoord)}else 13!=a.which||"text"!=N.tool||$("#text_input").is(":visible")?27==a.which&&"text"==N.tool&&Oa():Na()},this)),a.keyup($.proxy(function(a){if(16==a.which){if(Ka())return;Q(),wa(a),ua()}},this)),a.mousemove(function(a){Q(),N.newCoord=Wa(a),"paint"==N.tool&&"drawing"==N.state&&N.meta.lineEntries.push({state:N.state,coord:N.newCoord}),"start"==N.state&&(N.state="drawing"),null==N.newCoord&&"eyedropper"!=N.tool?ua(a):S(N,!0)}),q.mouseup(ua),l.mouseleave(R),q.mouseleave(R),r.on("update_drawing",Ua),r.on("add_layer",Va),r.on("receive_mouse_coords",Sa),r.on("disconnect",P),oa(),Ta()}function P(){$("#disconnected_indicator").show()}function Q(){null==N.layerCode&&(N.layerCode=randomString(t))}function R(a){N.newCoord=null,M=!1,ua(a)}function S(a,b){b&&ra(),"flood"==a.tool&&b&&"start"==a.state&&null==E||("eyedropper"!=a.tool||!b||"start"!=a.state&&"drawing"!=a.state?"paint"==a.tool?U(a,b):"line"==a.tool?T(a,b):"text"==a.tool?V(a,b):b&&Ra(a):(za(a),b&&Ra(a)))}function T(a,b){if("idle"==a.state)return void(b&&Ra(a));var c=da(a,b);"start"==a.state||"drawing"==a.state?("start"==a.state&&fa(c),b?(ka(a),ca(),aa(a,b),$.now()-v>f&&(v=$.now(),Qa(a))):aa(a,b)):"end"==a.state&&(aa(a,b),c.baseData=c.getImageData(0,0,i,j),Z(a,b),a.state="idle")}function U(a,b){if("start"==a.state||"drawing"==a.state)if(b){ka(a),ca();var c=JSON.parse(JSON.stringify(a));"start"==a.state&&(ba(a,b),Qa(c)),$.now()-v>e&&(ba(a,b),v=$.now(),Qa(c))}else null!=a.meta.lineEntries&&ba(a,b);else"end"==a.state?(b&&Qa(a),ba(a,b),Z(a,b),a.state="idle"):b&&Ra(a)}function V(a,b){var c=da(a,b);if(!b||null!=a.meta&&"undefined"!=typeof a.meta.text||X(a),b&&(la(a),ma(a)),"start"==a.state){if(b){if(!W(N))return;ca(),_(a,b,c),$("#text_input_box").val(I),$("#text_input").hide(),Qa(a),X(a)}else _(a,b,c);a.state="end",Z(a,b)}else"idle"==a.state&&Y(a,b);"end"==a.state&&(a.state="idle")}function W(a){return"text"!=a.tool||""!=a.meta.text||(Na(),a.state="end",!1)}function X(a){a.meta={text:"",fontFace:"ubuntuRegular",fontSize:null}}function Y(a,b){b&&Ra(a);var c=da(a,b,"_preview");c.clearRect(0,0,i,j),b&&!M||_(a,b,c)}function Z(a,b){if(b){var c=JSON.parse(JSON.stringify(a));c.state="end",Qa(c),"paint"==c.tool&&null!=c.meta&&null!=c.meta.lineEntries&&ba(c,!0),null!=E&&clearTimeout(E),E=setTimeout(function(){_a(c),a.layerCode=null},F)}}function _(a,b,c){if(null==a.newCoord)return void c.clearRect(0,0,i,j);c.font=a.meta.fontSize+"px "+a.meta.fontFace,c.fillStyle=a.colourFg,c.textAlign="right";var d={x:a.newCoord.x-H,y:a.newCoord.y+Math.ceil(a.meta.fontSize/2)};return c.fillText(a.meta.text,d.x,d.y),c}function aa(a,b){var c=da(a,b),d=c.createImageData(i,j);if("undefined"!=typeof c.baseData&&d.data.set(c.baseData.data.slice()),null!=a.meta){var e=a.meta.startCoord;if(null!=e){var f=a.newCoord;null!=f&&(ya(d.data,a,e.x,e.y,f.x,f.y),c.putImageData(d,0,0))}}}function ba(a,b){if(null==a.meta)return void console.log("Warning -> drawPaint called without data!");var c=da(a,b),d=c.getImageData(0,0,i,j),e=a.meta.lineEntries,f=e[0].coord;ya(d.data,a,f.x,f.y,f.x,f.y);for(var g=1;g<e.length;g++){var h=e[g-1].coord,k=e[g].coord;null!=h&&null!=k&&ya(d.data,a,h.x,h.y,k.x,k.y)}c.putImageData(d,0,0);var l=a.meta.lineEntries[a.meta.lineEntries.length-1];a.meta.lineEntries=[l]}function ca(){null!=E&&(clearTimeout(E),E=null)}function da(a,b,c){"undefined"==typeof c&&(c="");var d;if(b)d=o,"_preview"==c&&(d=p);else{var e=ea(a,c);d=e[0].getContext("2d")}return d}function ea(a,b){var c="canvas_layer_"+a.layerCode+b,d=$("#"+c);0==d.length&&(Xa(c),d=$("#"+c),Ya(d));var e=d[0];return"undefined"!=typeof e.deleteTimeout&&clearTimeout(e.deleteTimeout),e.deleteTimeout=setTimeout(function(){d.remove()},A),d}function fa(a){a.baseData=a.getImageData(0,0,i,j)}function ga(){ia("eyedropper"),ia("paint"),ia("line"),ia("flood"),ia("text"),$("#text").on("mouseup",function(){$("#text_input_box").focus()}),J=new ToolOptionMenu(this,"brush_size",null,null),K=new ToolOptionMenu(this,"font_size",null,null),L=new ToolOptionMenu(this,"font_face",function(a){var b=$("#"+a+"-menu").parent(),c=b.find(".ui-menu-item-wrapper");c.each(function(){var a=$(this);a.css("font-family",ha(a.html()))})},function(a){return'<span style="font-family: '+ha(a)+';">Font</span>'}),Ha("paint"),$(window).on("resize",function(){J.position(),K.position(),L.position(),Ja(),Pa()})}function ha(a){for(var b=a.split(" "),c="ubuntu",d=1;d<b.length;d++){var e=b[d];c+=e.substring(0,1).toUpperCase()+e.substring(1)}return c}function ia(a){$("#"+a).on("mousedown",function(){Ha(a),ja(a)})}function ja(a){N.tool=a}function ka(a){a.meta.brushSize=(parseInt($("#brush_size").val())-1)/2}function la(a){a.meta.fontSize=parseInt($("#font_size").val())}function ma(a){a.meta.fontFace=na()}function na(){return ha($("#font_face").val())}function oa(){D.spectrum({showAlpha:!1,cancelText:"Cancel",chooseText:"OK",show:pa})}function pa(){Ia(),Ja()}function qa(){var a=$(".sp-container").first();return!a.hasClass("sp-hidden")}function ra(){N.colourFg=D.spectrum("get").toRgbString()}function sa(a){N.newCoord=a,null!=N.newCoord&&(N.state="start","paint"==N.tool?(N.meta={lineEntries:[{state:N.state,coord:N.newCoord}]},v=$.now()):"line"==N.tool?ta(N):"text"!=N.tool&&(N.meta=null),S(N,!0))}function ta(a){a.meta={startCoord:a.newCoord}}function ua(a){"drawing"!=N.state&&"start"!=N.state||(N.state="end"),S(N,!0),N.dropperToggle&&wa(a)}function va(){N.dropperToggle=!0,N.prevTool=N.tool,N.tool="eyedropper",Ha(N.tool)}function wa(){N.dropperToggle=!1,N.tool=N.prevTool,"line"==N.tool&&ta(N),Ha(N.tool)}function xa(a){var b=a.meta.brushSize,c=[];for(x=0;x<2*b+1;x++){var d=[];for(y=0;y<2*b+1;y++){var e=(x-b)*(x-b)+(y-b)*(y-b)<=b*b;e?d.push(!0):d.push(!1)}c.push(d)}return c}function ya(a,b,c,d,e,f){for(var p,g=xa(b),h=Ca(b.colourFg),k=Math.abs(e-c),l=c<e?1:-1,m=-Math.abs(f-d),n=d<f?1:-1,o=k+m;;){for(var q=-b.meta.brushSize,r=0;r<g.length;r++)for(var s=0;s<g[r].length;s++)if(1==g[r][s]){var t=c+q+r,u=d+q+s;t>=0&&t<i&&u>=0&&u<j&&Fa(a,t,u,h)}if(c==e&&d==f)break;p=2*o,p>=m&&(o+=m,c+=l),p<=k&&(o+=k,d+=n)}}function za(a){if(null!=a.newCoord){var b=Aa(),c=b.getImageData(a.newCoord.x,a.newCoord.y,1,1).data;a.colourFg="rgba("+c[0]+", "+c[1]+", "+c[2]+", "+c[3]+")",D.spectrum("set",a.colourFg)}}function Aa(){var a=[];$(".drawing_layer").each(function(){a.push($(this))}),a.sort(function(a,b){var c=parseInt(a.css("z-index")),d=parseInt(b.css("z-index"));return c<d?-1:c>d?1:0});var b=n[0];b.setAttribute("width",i),b.setAttribute("height",j);var c=b.getContext("2d");c.clearRect(0,0,i,j);for(var d=0;d<a.length;d++){var e=a[d],f=parseInt(e.css("left")),g=parseInt(e.css("top"));c.drawImage(e[0],f,g)}return c}function Ca(a){var b=a.replace("rgb(","").replace("rgba(","").replace(")",""),c=b.split(","),d=parseFloat(c[3]);return out=[parseInt(c[0]),parseInt(c[1]),parseInt(c[2]),Math.round(255*(isNaN(d)?1:d))],out}function Ea(a,b){return Math.floor(b)*(4*i)+4*Math.floor(a)}function Fa(a,b,c,d){var e=Ea(b,c);a[e]=d[0],a[e+1]=d[1],a[e+2]=d[2],a[e+3]=d[3]}function Ha(a){var b=$("#"+a);$(".button_tool").each(function(){var a=$(this);a.attr("id")==b.attr("id")?a.addClass("button_pressed"):a.removeClass("button_pressed")}),"text"==a?Ma():Oa(),$(".controls_selectmenu").each(function(){var b=$(this).attr("id"),c=$("#"+b+"_container");"text"==a&&("font_face"==b||"font_size"==b)||("paint"==a||"line"==a)&&"brush_size"==b?c.show():c.hide()})}function Ia(a){Oa(),"undefined"!=typeof a&&"brush_size"!=a&&J.close(),"undefined"!=typeof a&&"font_size"!=a&&K.close(),"undefined"!=typeof a&&"font_face"!=a&&L.close()}function Ja(){var a=$(".sp-light").first().offset(),b=$(".sp-container").first();b.css({top:a.top+"px",left:a.left-b.width()+"px","z-index":2000000012})}function Ka(){return!!$("#text").hasClass("button_pressed")||(!!J.isOpen()||(!!qa()||!!La()))}function La(){return"none"!=$(".ui-dialog").css("display")}function Ma(){"none"==$("#text_input").css("display")?Na():Oa()}function Na(){Ia(),$("#text_input").show(),Pa();var a=$("#text_input_box");a.focus(),a.css("font-family",na()),a.focus(function(){$(this).select()}),a.keyup(function(){$(this).val()!=I&&(N.meta.text=$(this).val(),Y(N,!0))}),a.keydown(function(a){13==a.keyCode&&Oa()})}function Oa(){$("#text_input").hide()}function Pa(){var a=$("#text_input");if("none"!=a.css("display")){var b=$("#drawing_form"),c=b.offset(),d=c.left;a.css({top:c.top+"px",left:d+"px",width:i,"z-index":2000000012})}}function Qa(a){var b=getCookie("nick");null==b&&(b="Anonymous"),a.nickname=b,r.emit("receive_tool",a)}function Ra(a,b){return $.now()-v>h&&("paint"==a.tool&&null!=a.meta&&null!=a.meta.lineEntries&&(a.meta.lineEntries=null),Qa(a),v=$.now(),!0)}function Sa(a){var b=a.socketID,c=$("#drawing_pointer_"+b);if(null==a.newCoord)return c.fadeOut(B,function(){c.remove()}),void S(a,!1);if(0==c.length){var d='<div id="drawing_pointer_'+b+'" class="drawing_pointer"><div class="pointer_dot"></div><div id="drawing_pointer_label_'+b+'" class="pointer_label"></div></div>';$("#drawing_layers").append(d),c=$("#drawing_pointer_"+b)}c.css({left:a.newCoord.x+"px",top:a.newCoord.y+"px"});var e=a.nickname?a.nickname:"Anonymous";$("#drawing_pointer_label_"+b).text(e),c[0].timeout&&clearTimeout(c[0].timeout),c[0].timeout=setTimeout(function(){c.fadeOut(B,function(){c.remove()})},G),S(a,!1)}function Ta(){r.emit("get_drawing",{drawID:s})}function Ua(a){a=$.parseJSON(a);var b=null;$.each(a,function(a,c){var d=parseInt(a);(null==b||d<b)&&(b=d),$a(d,c,!1)})}function Va(a){a=$.parseJSON(a),$a(a.id,a.layer,!1)}function Wa(a){var b=k[0].getBoundingClientRect();if(void 0==a.clientX||void 0==a.clientY)return null;var c={x:Math.round(a.clientX-b.left),y:Math.round(a.clientY-b.top)};return c.x<0||c.x>=b.width||c.y<0||c.y>=b.height?null:c}function Xa(a){var b='<canvas id="'+a+'" width="'+i+'" height="'+j+'" style="z-index: 0;" class="drawing_canvas"> </canvas><canvas id="'+a+'_preview" width="'+i+'" height="'+j+'" style="z-index: 0;" class="drawing_canvas"> </canvas>';$("#drawing_layers").append(b)}function Ya(a){$(".drawing_canvas").each(function(){var a=$(this),b=parseInt(a.css("z-index"))-1;a.css("z-index",b)});var b=$("#"+a.attr("id")+"_preview");a.css("z-index",C),b.css("z-index",C)}function Za(a){var b=$("#canvas_layer_"+a);if(b.length>0)return b;var b=$("#drawing_layer_"+a);return b.length>0?b:null}function $a(a,b,c){var d={};d.layer=b,d.duplicate=Za(d.layer.code),d.previewDuplicate=Za(d.layer.code+"_preview"),null!=d.duplicate&&d.duplicate.attr("id","duplicate_temp");var e=c?1e3:0,f="drawing_layer_"+d.layer.code,g='<img id="'+f+'" class="drawing_layer" src="'+d.layer.base64+'" style="z-index: '+(a+e)+"; left: "+d.layer.offsets.left+"px; top: "+d.layer.offsets.top+'px;"/>';$("#drawing_layers").append(g),$("#"+f).imagesLoaded().done(function(){if("undefined"!=typeof d.layer.components)for(var a=d.layer.components,b=0;b<a.length;b++){var c=a[b],e=Za(c);null!=e&&e.remove();var f=Za(a[b]);null!=f&&f.remove()}null!=d.duplicate&&d.duplicate.remove(),null!=d.previewDuplicate&&d.previewDuplicate.remove()}),a>u&&(u=a)}function _a(a){var b=a.layerCode,c=ab(b);o.clearRect(0,0,i,j);var d=bb(c[0],m[0],a);m[0].toBlob(function(a){var e=new FileReader;e.onload=function(e){var f={drawID:s,base64:e.target.result,offsets:d,code:b};$a(u+1,f,!0),c.remove();var g=new window.FileReader;g.readAsDataURL(a),g.onloadend=function(){g.result;r.emit("add_layer",f)}},e.readAsDataURL(a)},"image/png")}function ab(a){var b="drawing_canvas_cpy_"+a,c='<canvas id="'+b+'" class="drawing_canvas_cpy" width="'+i+'" height="'+j+'"></canvas>',d=$(c),e=o.getImageData(0,0,i,j);return d[0].getContext("2d").putImageData(e,0,0),d.insertBefore(k),d}function bb(a,b,c){var d=a.getContext("2d"),e=a.width,f=a.height,g=d.getImageData(0,0,e,f),h=g.data,i=function(a,b){var c=e*b+a,d=h[4*c+3];return 0!=d},j=function(a){for(var b=a?1:-1,c=a?0:f-1;a?c<f:c>-1;c+=b)for(var d=0;d<e;d++)if(i(d,c))return c;return null},k=function(a){for(var b=a?1:-1,c=a?0:e-1;a?c<e:c>-1;c+=b)for(var d=0;d<f;d++)if(i(c,d))return c;return null},l=j(!0),m=j(!1)+1,n=k(!0),o=k(!1)+1,p=o-n,q=m-l;return b.setAttribute("width",p),b.setAttribute("height",q),b.getContext("2d").drawImage(a,n,l,p,q,0,0,p,q),{top:l,right:o,bottom:m,left:n}}var d=33,e=d,f=d,h=20,i=b,j=c,k=$("#drawing_canvas"),l=$("#drawing_canvas_preview"),m=$("#crop_canvas"),n=$("#scratch_canvas"),o=k[0].getContext("2d"),p=l[0].getContext("2d"),q=$(document),r=io.connect("/drawing_socket_"+a),s=a,t=32,u=1,v=$.now(),A=($.now(),4e3),B=120,C=999999999,D=$("#colour_picker"),E=null,F=1e3,G=4e3,H=10,I="Enter text",J=null,K=null,L=null,M=!1,N={state:"idle",tool:"paint",meta:null};this.methods={closeMenus:Ia},O()}function ToolOptionMenu(a,b,c,d){function k(){g.selectmenu({open:function(){j.position()},close:function(a){var b=$("#"+f+"-button");b.removeClass("button_pressed"),b.blur()},create:l,select:l}),$("#"+f+"-button").addClass("button_tool")}function l(){var a=$("#"+f),b=a.selectmenu("widget"),c=null!=i?i($(this).val()):$(this).val();b.html('<span class="ui-selectmenu-text"><i class="fa fa-caret-left" aria-hidden="true"></i>&nbsp;'+c+"</span>")}var e=a,f=b,g=$("#"+f),h=c,i=d,j=this;this.position=function(){var a=$("#"+f+"-menu").parent();if("none"!=a.css("display")){e.methods.closeMenus(f);var b=$("#"+f+"-button");a.hide(),null!=h&&h(f);var c=b.offset();a.show(),a.css({top:c.top-a.height()+45+"px",left:c.left-a.width()+"px","z-index":2000000012}),$("#"+f+"-button").addClass("button_pressed")}},this.close=function(){$("#"+f+"-button").removeClass("button_pressed"),$("#"+f).selectmenu("close")},this.isOpen=function(){return"none"!=$("#"+f+"-menu").parent().css("display")},k()}function randomString(a){for(var b="",c="abcdefghijklmnopqrstuvwxyz0123456789",d=0;d<a;d++)b+=c.charAt(Math.floor(Math.random()*c.length));return b}function setCookie(a,b,c){var d=new Date;d.setTime(d.getTime()+24*c*60*60*1e3);var e="expires="+d.toUTCString();document.cookie=a+"="+b+";"+e+";path=/"}function getCookie(a){for(var b=a+"=",c=decodeURIComponent(document.cookie),d=c.split(";"),e=0;e<d.length;e++){for(var f=d[e];" "==f.charAt(0);)f=f.substring(1);if(0==f.indexOf(b))return f.substring(b.length,f.length)}return null}function Timeline(){this.entries=[],this.log=function(a){var b=Date.now();this.entries.push({name:a,ts:b})},this.dump=function(){console.log("Timeline.dump() invoked");for(var a,b=null,c=0;c<this.entries.length;c++){var a=this.entries[c];if(null!=b){var d=a.ts-b.ts;console.log("["+b.name+"] => ["+a.name+"] "+d+" ms")}b=a}}}