function initSplash(){$("#create_drawing_btn").click(function(){$.ajax({url:"/create_drawing"}).done(function(t){window.location.href="/d/"+t})}),configureNick()}function configureNick(){setupNickModal();var t=getCookie("nick");null==t?showNickModal():($("#nick_dialog").hide(),$("#nick_indicator").text(t)),$("#change_nick_btn").click(function(){showNickModal(!0)})}function showNickModal(t){var e=getCookie("nick");null!=e&&$("#nick_input").val(e),$("#nick_dialog").dialog("open"),t&&($("#nick_message").html("Please enter a new nickname."),$(".ui-dialog-title").html("Alert"))}function setupNickModal(){$("#nick_dialog").dialog({resizable:!1,height:202,width:400,modal:!0,draggable:!1,autoOpen:!1,closeOnEscape:!1,open:function(t,e){$(".ui-widget-overlay").css({"background-color":"#000",opacity:.5,"z-index":2000000020}),$(".ui-dialog").css({"z-index":2000000021}),$("#nick_input").click(function(){$(this).select()}),$("#nick_input").select(),$("#nick_button").click(function(){var t=$("#nick_input").val();setCookie("nick",t,30),$("#nick_indicator").text(t),$("#nick_dialog").dialog("close")}),$(".ui-dialog-titlebar-close").hide(),$("#nick_dialog").show()}})}function drawUI(t,e,n){function o(){C();var t=$("body");kt.mousedown($.proxy(function(t){if(a(),F(),3==t.which){if(et())return;U()}return R(ft(t)),!1},this)),kt.mouseenter(function(t){qt=!0,A()||1==event.which&&(a(),R(ft(t)))}),kt.contextmenu(function(t){return!1}),t.keydown($.proxy(function(t){if(16==t.which){if(et())return;a(),Z(),U(),R(Kt.newCoord)}},this)),t.keyup($.proxy(function(t){if(16==t.which){if(et())return;a(),L(t),J()}},this)),t.mousemove(function(t){a(),Kt.newCoord=ft(t),"paint"==Kt.tool&&"drawing"==Kt.state&&Kt.meta.lineEntries.push({state:Kt.state,coord:Kt.newCoord}),"start"==Kt.state&&(Kt.state="drawing"),null==Kt.newCoord&&"eyedropper"!=Kt.tool?J(t):r(Kt,!0)}),St.mouseup(J),kt.mouseleave(i),St.mouseleave(i),Tt.on("update_drawing",ct),Tt.on("add_layer",dt),Tt.on("receive_mouse_coords",st),O(),ut()}function a(){null==Kt.layerCode&&(Kt.layerCode=randomString(Nt))}function i(t){console.log("mouseOut with coord",Kt.newCoord),Kt.newCoord=null,qt=!1,J(t)}function r(t,e){e&&F(),"flood"==t.tool&&e&&"start"==t.state&&null==Ut?(X(t),p(t,e)):"eyedropper"!=t.tool||!e||"start"!=t.state&&"drawing"!=t.state?"paint"==t.tool?s(t,e):"line"==t.tool?l(t,e):"text"==t.tool?u(t,e):e&&lt(t):(P(t),e&&lt(t))}function l(t,e){if("idle"==t.state)return void(e&&lt(t));var n=m(t,e);"start"==t.state||"drawing"==t.state?("start"==t.state&&b(n),e?(D(t),w(),g(t,e),$.now()-Ft>xt&&(Ft=$.now(),lt(t))):g(t,e)):"end"==t.state&&(g(t,e),n.baseData=n.getImageData(0,0,yt,bt),p(t,e),t.state="idle")}function s(t,e){if("start"==t.state||"drawing"==t.state)if(e){D(t),w();var n=JSON.parse(JSON.stringify(t));"start"==t.state&&(h(t,e),lt(n)),$.now()-Ft>$t?(h(t,e),Ft=$.now(),lt(n)):(n.meta.lineEntries=null,lt(n))}else null!=t.meta.lineEntries&&h(t,e);else"end"==t.state?(e&&lt(t),h(t,e),p(t,e),t.state="idle"):e&&lt(t)}function u(t,e){var n=m(t,e);if(!e||null!=t.meta&&"undefined"!=typeof t.meta.text||d(t),e&&(M(t),S(t)),"start"==t.state){if(e){if(!c(Kt))return;w(),v(t,e,n),$("#text_input_box").val(Bt),$("#text_input").hide(),lt(t),d(t)}else v(t,e,n);t.state="end",p(t,e)}else"idle"==t.state&&f(t,e);"end"==t.state&&(t.state="idle")}function c(t){return"text"==t.tool&&""==t.meta.text?(at(),$("#text_input_box").focus(),t.state="end",!1):!0}function d(t){t.meta={text:"",fontFace:"ubuntuRegular",fontSize:null}}function f(t,e){e&&lt(t);var n=m(t,e,"_preview");n.clearRect(0,0,yt,bt),(!e||qt)&&v(t,e,n)}function p(t,e){if(e){var n=m(t,e),o=JSON.parse(JSON.stringify(t));o.state="end",lt(o),"paint"==o.tool&&null!=o.meta&&null!=o.meta.lineEntries&&h(o,!0),null!=Ut&&clearTimeout(Ut),Ut=setTimeout(function(){console.log("finaliseTimeout invoked"),wt(Ct[0],zt[0],o,n),t.layerCode=null},Lt)}}function v(t,e,n){if(null==t.newCoord)return void n.clearRect(0,0,yt,bt);n.font=t.meta.fontSize+"px "+t.meta.fontFace,n.fillStyle=t.colourFg,n.textAlign="right";var o={x:t.newCoord.x-jt,y:t.newCoord.y+Math.ceil(t.meta.fontSize/2)};return n.fillText(t.meta.text,o.x,o.y),n}function g(t,e){var n=m(t,e),o=n.createImageData(yt,bt);if("undefined"!=typeof n.baseData&&o.data.set(n.baseData.data.slice()),null!=t.meta){var a=t.meta.startCoord;if(null!=a){var i=t.newCoord;null!=i&&(B(o.data,t,a.x,a.y,i.x,i.y),n.putImageData(o,0,0))}}}function h(t,e){if(null==t.meta)return void console.log("Warning -> drawPaint called without data!");var n=m(t,e),o=n.getImageData(0,0,yt,bt),a=t.meta.lineEntries,i=a[0].coord;B(o.data,t,i.x,i.y,i.x,i.y);for(var r=1;r<a.length;r++){var l=a[r-1].coord,s=a[r].coord;null!=l&&null!=s&&B(o.data,t,l.x,l.y,s.x,s.y)}n.putImageData(o,0,0);var u=t.meta.lineEntries[t.meta.lineEntries.length-1];t.meta.lineEntries=[u]}function w(){null!=Ut&&(clearTimeout(Ut),Ut=null)}function m(t,e,n){"undefined"==typeof n&&(n="");var o;if(e)o=Dt,"_preview"==n&&(o=Mt);else{var a=_(t,n);o=a[0].getContext("2d")}return o}function _(t,e){var n="canvas_layer_"+t.layerCode+e,o=$("#"+n);return 0==o.length&&(pt(n),o=$("#"+n)),vt(o),o}function b(t){t.baseData=t.getImageData(0,0,yt,bt)}function C(){z("eyedropper"),z("paint"),z("line"),z("flood"),z("text"),$("#text").on("mouseup",function(){$("#text_input_box").focus()}),Pt=new ToolOptionMenu(this,"brush_size",null,null),Xt=new ToolOptionMenu(this,"font_size",null,null),Yt=new ToolOptionMenu(this,"font_face",function(t){var e=$("#"+t+"-menu").parent(),n=e.find(".ui-menu-item-wrapper");n.each(function(){var t=$(this);t.css("font-family",k(t.html()))})},function(t){return'<span style="font-family: '+k(t)+';">Font</span>'}),V("paint"),$(window).on("resize",function(){Pt.position(),Xt.position(),Yt.position(),tt(),rt()})}function k(t){for(var e=t.split(" "),n="ubuntu",o=1;o<e.length;o++){var a=e[o];n+=a.substring(0,1).toUpperCase()+a.substring(1)}return n}function z(t){$("#"+t).on("mousedown",function(){V(t),I(t)})}function I(t){Kt.tool=t}function D(t){t.meta.brushSize=(parseInt($("#brush_size").val())-1)/2}function M(t){t.meta.fontSize=parseInt($("#font_size").val())}function S(t){t.meta.fontFace=T()}function T(){return k($("#font_face").val())}function O(){Jt.spectrum({showAlpha:!1,cancelText:"Cancel",chooseText:"OK",show:N})}function N(){Z(),tt()}function A(){var t=$(".sp-container").first();return t.hasClass("sp-hidden")?!1:!0}function F(){Kt.colourFg=Jt.spectrum("get").toRgbString()}function R(t){Kt.newCoord=t,null!=Kt.newCoord&&(Kt.state="start","paint"==Kt.tool?(Kt.meta={lineEntries:[{state:Kt.state,coord:Kt.newCoord}]},Ft=$.now()):"line"==Kt.tool?E(Kt):"text"!=Kt.tool&&(Kt.meta=null),r(Kt,!0))}function E(t){t.meta={startCoord:t.newCoord}}function J(t){("drawing"==Kt.state||"start"==Kt.state)&&(Kt.state="end"),r(Kt,!0),Kt.dropperToggle&&L(t)}function U(){Kt.dropperToggle=!0,Kt.prevTool=Kt.tool,Kt.tool="eyedropper",V(Kt.tool)}function L(){Kt.dropperToggle=!1,Kt.tool=Kt.prevTool,"line"==Kt.tool&&E(Kt),V(Kt.tool)}function j(t){var e=t.meta.brushSize,n=[];for(x=0;x<2*e+1;x++){var o=[];for(y=0;y<2*e+1;y++){var a=(x-e)*(x-e)+(y-e)*(y-e)<=e*e;a?o.push(!0):o.push(!1)}n.push(o)}return n}function B(t,e,n,o,a,i){for(var r,l=j(e),s=K(e.colourFg),u=Math.abs(a-n),c=a>n?1:-1,d=-Math.abs(i-o),f=i>o?1:-1,p=u+d;;){for(var v=-e.meta.brushSize,g=0;g<l.length;g++)for(var h=0;h<l[g].length;h++)if(1==l[g][h]){var w=n+v+g,m=o+v+h;w>=0&&yt>w&&m>=0&&bt>m&&H(t,w,m,s)}if(n==a&&o==i)break;r=2*p,r>=d&&(p+=d,n+=c),u>=r&&(p+=u,o+=f)}}function P(t){if(null!=t.newCoord){var e=Y(),n=e.getImageData(t.newCoord.x,t.newCoord.y,1,1).data;t.colourFg="rgba("+n[0]+", "+n[1]+", "+n[2]+", "+n[3]+")",Jt.spectrum("set",t.colourFg)}}function X(t){var e=Y(),n=e.getImageData(t.newCoord.x,t.newCoord.y,1,1).data,o=K(t.colourFg);q(e,Dt,t.newCoord.x,t.newCoord.y,n,o)}function Y(){var t=[];$(".drawing_layer").each(function(){t.push($(this))}),t.sort(function(t,e){var n=parseInt(t.css("z-index")),o=parseInt(e.css("z-index"));return o>n?-1:n>o?1:0});var e=It[0];e.setAttribute("width",yt),e.setAttribute("height",bt);var n=e.getContext("2d");n.clearRect(0,0,yt,bt);for(var o=0;o<t.length;o++){var a=t[o],i=parseInt(a.css("left")),r=parseInt(a.css("top"));n.drawImage(a[0],i,r)}return n}function q(t,e,n,o,a,i){var r=t.getImageData(0,0,yt,bt),l=e.getImageData(0,0,yt,bt),s=[];for(s.push([n,o]);s.length>0;){var u=s.pop(),n=u[0],o=u[1],c=W(r.data,n,o),d=W(l.data,n,o),f=3;Q(c,a,f)&&!Q(d,i,f)&&(H(r.data,n,o,i),H(l.data,n,o,i),n>0&&s.push([n-1,o]),o>0&&s.push([n,o-1]),yt-1>n&&s.push([n+1,o]),bt-1>o&&s.push([n,o+1]))}e.putImageData(l,0,0)}function K(t){var e=t.replace("rgb(","").replace("rgba(","").replace(")",""),n=e.split(","),o=parseFloat(n[3]);return out=[parseInt(n[0]),parseInt(n[1]),parseInt(n[2]),Math.round(255*(isNaN(o)?1:o))],out}function W(t,e,n){var o=G(e,n);return[t[o],t[o+1],t[o+2],t[o+3]]}function G(t,e){return Math.floor(e)*(4*yt)+4*Math.floor(t)}function H(t,e,n,o){var a=G(e,n);t[a]=o[0],t[a+1]=o[1],t[a+2]=o[2],t[a+3]=o[3]}function Q(t,e,n){for(var o=0;4>o;o++)if(Math.abs(t[0]-e[0])>n||Math.abs(t[1]-e[1])>n||Math.abs(t[2]-e[2])>n||Math.abs(t[3]-e[3])>n)return!1;return!0}function V(t){var e=$("#"+t);$(".button_tool").each(function(){var t=$(this);t.attr("id")==e.attr("id")?t.addClass("button_pressed"):t.removeClass("button_pressed")}),"text"==t?ot():it(),$(".controls_selectmenu").each(function(){var e=$(this).attr("id"),n=$("#"+e+"_container");"text"==t&&("font_face"==e||"font_size"==e)||("paint"==t||"line"==t)&&"brush_size"==e?n.show():n.hide()})}function Z(t){it(),"undefined"!=typeof t&&"brush_size"!=t&&Pt.close(),"undefined"!=typeof t&&"font_size"!=t&&Xt.close(),"undefined"!=typeof t&&"font_face"!=t&&Yt.close()}function tt(){var t=$(".sp-light").first().offset(),e=$(".sp-container").first();e.css({top:t.top+"px",left:t.left-e.width()+"px","z-index":2000000012})}function et(){return $("#text").hasClass("button_pressed")?!0:Pt.isOpen()?!0:A()?!0:nt()?!0:!1}function nt(){return"none"==$(".ui-dialog").css("display")?!1:!0}function ot(){"none"==$("#text_input").css("display")?at():it()}function at(){Z(),$("#text_input").show(),rt();var t=$("#text_input_box");t.css("font-family",T()),t.focus(function(){$(this).select()}),t.keyup(function(){$(this).val()!=Bt&&(Kt.meta.text=$(this).val(),f(Kt,!0))}),t.keydown(function(t){13==t.keyCode&&it()})}function it(){$("#text_input").hide()}function rt(){var t=$("#text_input");if("none"!=t.css("display")){var e=$("#drawing_form"),n=e.offset(),o=n.left;t.css({top:n.top+"px",left:o+"px",width:yt,"z-index":2000000012})}}function lt(t){var e=getCookie("nick");null==e&&(e="Anonymous"),t.nickname=e,Tt.emit("receive_tool",t)}function st(t){var e=t.socketID,n=$("#drawing_pointer_"+e);if(null==t.newCoord)return n.fadeOut(Rt,function(){n.remove()}),void r(t,!1);if(0==n.length){var o='<div id="drawing_pointer_'+e+'" class="drawing_pointer"><div class="pointer_dot"></div><div id="drawing_pointer_label_'+e+'" class="pointer_label"></div></div>';$("#drawing_layers").append(o),n=$("#drawing_pointer_"+e)}n.css({left:t.newCoord.x+"px",top:t.newCoord.y+"px"});var a=t.nickname?t.nickname:"Anonymous";$("#drawing_pointer_label_"+e).text(a),r(t,!1)}function ut(){Tt.emit("get_drawing",{drawID:Ot})}function ct(t){t=$.parseJSON(t);var e=null;$.each(t,function(t,n){var o=parseInt(t);(null==e||e>o)&&(e=o),ht(o,n,!1)})}function dt(t){t=$.parseJSON(t),ht(t.id,t.layer,!1)}function ft(t){var e=Ct[0].getBoundingClientRect();if(void 0==t.clientX||void 0==t.clientY)return null;var n={x:Math.round(t.clientX-e.left),y:Math.round(t.clientY-e.top)};return n.x<0||n.x>=e.width||n.y<0||n.y>=e.height?null:n}function pt(t){var e='<canvas id="'+t+'" width="'+yt+'" height="'+bt+'" style="z-index: 0;" class="drawing_canvas"> </canvas><canvas id="'+t+'_preview" width="'+yt+'" height="'+bt+'" style="z-index: 0;" class="drawing_canvas"> </canvas>';$("#drawing_layers").append(e)}function vt(t){$(".drawing_canvas").each(function(){var t=$(this),e=parseInt(t.css("z-index"))-1;t.css("z-index",e)});var e=$("#"+t.attr("id")+"_preview");t.css("z-index",Et),e.css("z-index",Et)}function gt(t){var e=$("#canvas_layer_"+t);if(e.length>0)return e;var e=$("#drawing_layer_"+t);return e.length>0?e:null}function ht(t,e,n){var o={};o.layer=e,o.duplicate=gt(o.layer.code),o.previewDuplicate=gt(o.layer.code+"_preview"),null!=o.duplicate&&o.duplicate.attr("id","duplicate_temp");var a=n?1e3:0,i="drawing_layer_"+o.layer.code,r='<img id="'+i+'" class="drawing_layer" src="'+o.layer.base64+'" style="z-index: '+(t+a)+"; left: "+o.layer.offsets.left+"px; top: "+o.layer.offsets.top+'px;"/>';$("#drawing_layers").append(r),$("#"+i).imagesLoaded().done(function(){if("undefined"!=typeof o.layer.components)for(var t=o.layer.components,e=0;e<t.length;e++){var n=t[e],a=gt(n);null!=a&&a.remove();var i=gt(t[e]);null!=i&&i.remove()}null!=o.duplicate&&o.duplicate.remove(),null!=o.previewDuplicate&&o.previewDuplicate.remove()}),t>At&&(At=t)}function wt(t,e,n){var o=n.layerCode,a=mt(t,e,n);e.toBlob(function(t){var e=new FileReader;e.onload=function(e){var n={drawID:Ot,base64:e.target.result,offsets:a,code:o};ht(At+1,n,!0),Dt.clearRect(0,0,yt,bt);var i=new window.FileReader;i.readAsDataURL(t),i.onloadend=function(){i.result;Tt.emit("add_layer",n),Ut=null}},e.readAsDataURL(t)},"image/png")}function mt(t,e,n){var o=t.getContext("2d"),a=t.width,i=t.height,r=o.getImageData(0,0,a,i),l=r.data,s=function(t,e){var n=a*e+t,o=l[4*n+3];return 0!=o?!0:!1},u=function(t){for(var e=t?1:-1,n=t?0:i-1;t?i>n:n>-1;n+=e)for(var o=0;a>o;o++)if(s(o,n))return n;return null},c=function(t){for(var e=t?1:-1,n=t?0:a-1;t?a>n:n>-1;n+=e)for(var o=0;i>o;o++)if(s(n,o))return n;return null},d=u(!0),f=u(!1)+1,p=c(!0),v=c(!1)+1,g=v-p,h=f-d;return e.setAttribute("width",g),e.setAttribute("height",h),e.getContext("2d").drawImage(t,p,d,g,h,0,0,g,h),{top:d,right:v,bottom:f,left:p}}var _t=33,$t=_t,xt=_t,yt=e,bt=n,Ct=$("#drawing_canvas"),kt=$("#drawing_canvas_preview"),zt=$("#crop_canvas"),It=$("#scratch_canvas"),Dt=Ct[0].getContext("2d"),Mt=kt[0].getContext("2d"),St=$(document),Tt=io.connect("/drawing_socket_"+t),Ot=t,Nt=32,At=1,Ft=$.now(),Rt=120,Et=999999999,Jt=$("#colour_picker"),Ut=null,Lt=1e3,jt=10,Bt="Enter text",Pt=null,Xt=null,Yt=null,qt=!1,Kt={state:"idle",tool:"paint",meta:null};this.methods={closeMenus:Z},o()}function ToolOptionMenu(t,e,n,o){function a(){s.selectmenu({open:function(){d.position()},close:function(t){var e=$("#"+l+"-button");e.removeClass("button_pressed"),e.blur()},create:i,select:i}),$("#"+l+"-button").addClass("button_tool")}function i(){var t=$("#"+l),e=t.selectmenu("widget"),n=null!=c?c($(this).val()):$(this).val();e.html('<span class="ui-selectmenu-text"><i class="fa fa-caret-left" aria-hidden="true"></i>&nbsp;'+n+"</span>")}var r=t,l=e,s=$("#"+l),u=n,c=o,d=this;this.position=function(){var t=$("#"+l+"-menu").parent();if("none"!=t.css("display")){r.methods.closeMenus(l);var e=$("#"+l+"-button");t.hide(),null!=u&&u(l);var n=e.offset();t.show(),t.css({top:n.top-t.height()+45+"px",left:n.left-t.width()+"px","z-index":2000000012}),$("#"+l+"-button").addClass("button_pressed")}},this.close=function(){$("#"+l+"-button").removeClass("button_pressed"),$("#"+l).selectmenu("close")},this.isOpen=function(){return"none"!=$("#"+l+"-menu").parent().css("display")?!0:!1},a()}function randomString(t){for(var e="",n="abcdefghijklmnopqrstuvwxyz0123456789",o=0;t>o;o++)e+=n.charAt(Math.floor(Math.random()*n.length));return e}function setCookie(t,e,n){var o=new Date;o.setTime(o.getTime()+24*n*60*60*1e3);var a="expires="+o.toUTCString();document.cookie=t+"="+e+";"+a+";path=/"}function getCookie(t){for(var e=t+"=",n=decodeURIComponent(document.cookie),o=n.split(";"),a=0;a<o.length;a++){for(var i=o[a];" "==i.charAt(0);)i=i.substring(1);if(0==i.indexOf(e))return i.substring(e.length,i.length)}return null}